# AMAZON RELATIONAL DATABASE SERVICE
Amazon Relational Database Service (Amazon RDS) is a web service that makes it easier to set up, operate, and scale a relational database in the AWS Cloud. It provides cost-efficient, resizable capacity for an industry-standard relational database and manages common database administration tasks.

# DB instances
The basic building block of Amazon RDS is the DB instance. A DB instance is an isolated database environment in the AWS Cloud. Your DB instance can contain multiple user-created databases. You can access your DB instance by using the same tools and applications that you use with a standalone database instance. 

# Amazon VPC
You run a DB instance on a virtual private cloud (VPC) using the Amazon Virtual Private Cloud (Amazon VPC) service. When you use a VPC, you have control over your virtual networking environment.

# Instances Engine
Each DB instance runs a DB engine. Amazon RDS currently supports the MySQL, MariaDB, PostgreSQL, Oracle, and Microsoft SQL Server DB engines. Each DB engine has its own supported features, and each version of a DB engine may include specific features. Additionally, each DB engine has a set of parameters in a DB parameter group that control the behavior of the databases that it manages.

# DB instances class
The computation and memory capacity of a DB instance is determined by its DB instance class. 

# DB instances storage
DB instance storage comes in three types: Magnetic, General Purpose (SSD), and Provisioned IOPS (PIOPS). They differ in performance characteristics and price, there's no additional cost to run your DB instance in a VPC. 

# AWS Regions and Availability Zones
Amazon cloud computing resources are housed in highly available data center facilities in different areas of the world. Each data center location is called an AWS Region.Each AWS Region contains multiple distinct locations called Availability Zones, or AZs. You can run your DB instance in several Availability Zones, an option called a Multi-AZ deployment. 

# Security Group
A security group controls the access to a DB instance. It does so by allowing access to IP address ranges or Amazon EC2 instances that you specify.

# Amazon RDS for MySql 
MySQL is the world's most popular open source relational database and Amazon RDS makes it easy to set up, operate, and scale MySQL deployments in the cloud. With Amazon RDS, you can deploy scalable MySQL servers in minutes with cost-efficient and resizable hardware capacity.
Amazon RDS for MySQL frees you up to focus on application development by managing time-consuming database administration tasks including backups, software patching, monitoring, scaling and replication.
Amazon RDS supports DB instances running several versions of MySQL.

# Database Credentials
On creating a Database Instance, AWS will create Databse credentials with:
{username: "admin", 
password: "generated by aws", 
databaseName: "if not provided by us"
instanceIdentifier: "generated by aws",
resourceArn: "generated by aws", 
secretArn: "generated by aws",
InstanceEndpoint: "generated by aws"}

we would require this to access our database from within lambda either through secrets manager or environment variables

#### Reference
[What is AWS Relational Database Service](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/Welcome.html), 
[MySQL on AWS RDS](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_MySQL.html)



## Stack Code

## Step 1
install & import modules:
`"@aws-cdk/aws-rds"` ,
`"@aws-cdk/aws-secretsmanager"` ,
`"@aws-cdk/aws-iam"` ,
`@aws-cdk/aws-ec2"`.


Add the following constructs in your stack
```javascript

// step #1: create a vpc for RDS instance

   const vpc = new ec2.Vpc(this, "myrdsvpc");
  
  
 // step #2: create database instance
 
     const myDBInstance = new rds.DatabaseInstance(this, "MySQL", {
      instanceType: ec2.InstanceType.of(
        ec2.InstanceClass.BURSTABLE3,
        ec2.InstanceSize.SMALL
      ),
      vpc,
      engine: rds.DatabaseInstanceEngine.mysql({
        version: rds.MysqlEngineVersion.VER_5_6_39,
      }),
      publiclyAccessible: true,
      multiAz: false,
      allocatedStorage: 100,
      storageType: rds.StorageType.STANDARD,
      cloudwatchLogsExports: ["audit", "error", "general"],
      databaseName: "mySqlDataBase",
      deletionProtection: false,
      vpcPlacement: { subnetType: ec2.SubnetType.PUBLIC },
    });

 // step #3: give lambda permissions to access RDS and VPC from aws managed policy
 
   const role = new iam.Role(this, "LambdaRole", {
      assumedBy: new iam.ServicePrincipal("lambda.amazonaws.com"),
      managedPolicies: [
        iam.ManagedPolicy.fromAwsManagedPolicyName("AmazonRDSDataFullAccess"),
        iam.ManagedPolicy.fromAwsManagedPolicyName(
          "service-role/AWSLambdaVPCAccessExecutionRole"
        ),
      ],
    });
    
  // step #4: create a lambda function with role and vpc to access database providing database endpoint and database credential in environmental variables. 
  Lambda can access these through Secrets Manager too but for that lambda would require permission to access secrets manager too.
  
      const hello = new lambda.Function(this, "HelloHandler", {
      runtime: lambda.Runtime.NODEJS_10_X,
      code: lambda.Code.fromAsset("lambda/lambda-p.zip"),
      handler: "index.handler",
      timeout: cdk.Duration.minutes(1),
      vpc,
      role,
      environment: {
        INSTANCE_CREDENTIALS: `${
          SM.Secret.fromSecretAttributes(this, "dbcredentials", { secretArn: foo })
            .secretValue
        }`,
        HOST: myDBInstance.dbInstanceEndpointAddress,
      },
    });
    
    // step #5: create lambda once dbinstance is created as we have to provide credentials
    hello.node.addDependency(myDBInstance);
    
    // step #6: allow lambda to connect to the database instance

    myDBInstance.grantConnect(hello);
    .................................
    
 



```
# Accessing your database
In order to access your MySQL database locally install MySQL Client on your system or use Online Tool MySQL Workbench using instances' endpoint(aka, host-name), database name and  password (in our case provided by AWS ).
In this step we will access our database with Lambda using a client library. For this we will provide permissions to lambda to have full access to RDS.


# Welcome to your CDK TypeScript project!

## Useful commands

 * `npm run build`   compile typescript to js
 * `npm run watch`   watch for changes and compile
 * `npm run test`    perform the jest unit tests
 * `cdk deploy`      deploy this stack to your default AWS account/region
 * `cdk diff`        compare deployed stack with current state
 * `cdk synth`       emits the synthesized CloudFormation template

